name: Ukentlig Aksje Screener Pipeline

on:
  # Kj칮rer jobben hver l칮rdag kl. 06:00 UTC (07:00 Oslo vinter/08:00 sommer)
  schedule:
    - cron: '0 6 * * 6' # <-- ENDRET TIL L칒RDAG (6)
  # Tillater manuell kj칮ring fra GitHub UI for testing
  workflow_dispatch:

permissions:
  # N칮dvendig for 친 kunne opprette/oppdatere GitHub Releases assets
  contents: write

jobs:
  run_screener:
    runs-on: ubuntu-latest
    steps:
    - name: 拘勇 Sjekk ut kode
      uses: actions/checkout@v4

    - name: 游냀 Sett opp Python Milj칮
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: 游닍 Installer Python-avhengigheter
      # Dette er alle bibliotekene fra requirements.txt, pluss lxml/html5lib for Wikipedia-henting
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy yfinance requests altair lxml html5lib

    - name: 丘뙖잺 Kj칮r Screening Motor (Oppretter CSV-filer)
      run: |
        python screener_motor.py

    - name: 游댍 Debug - finn genererte CSV-filer
      run: |
        echo "PWD=$(pwd)"
        ls -lah
        echo "Searching for top_candidates*.csv ..."
        find . -maxdepth 4 -type f -name "top_candidates*.csv" -print

    - name: 游닋 Publiser CSV til GitHub Release (latest + historikk)
      # Bruker softprops/action-gh-release for 친 enkelt oppdatere assets i en Release
      uses: softprops/action-gh-release@v1
      with:
        # En stabil tag for Streamlit-appen 친 peke p친
        tag_name: latest-screener-data
        name: Siste Toppkandidater
        draft: false
        prerelease: false
        # VIKTIG FIKS: Sikrer at filen blir OVERWRITTEN i releasen, som er essensielt for 친 unng친 caching-problemer
        overwrite: true # <-- NY LINJE
        # Laster opp begge filene generert av screener_motor.py
        files: |
          top_candidates_latest.csv
          top_candidates_*.csv
        fail_on_unmatched_files: true
      env:
        # Bruker den innebygde GITHUB_TOKEN for autorisasjon
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
